{% extends "base.html" %}

{% block title %}Dashboard - Investment Tracker{% endblock %}

{% block content %}
<h2>Portfolio Dashboard</h2>

<div class="summary-cards">
    <div class="summary-card">
        <div class="summary-label">Total Value</div>
        <div class="summary-value">${{ total_value }}</div>
    </div>
    
    <div class="summary-card">
        <div class="summary-label">Total Cost</div>
        <div class="summary-value">${{ total_cost }}</div>
    </div>
    
    <div class="summary-card {% if profit_loss >= 0 %}positive{% else %}negative{% endif %}">
        <div class="summary-label">Profit / Loss</div>
        <div class="summary-value">
            ${{ profit_loss }}
            <span class="summary-percent">({{ return_pct }}%)</span>
        </div>
    </div>
</div>

{% if has_investments %}
<div class="chart-container">
    <h3>Asset Allocation</h3>
    <canvas id="allocationChart"></canvas>
</div>

<div class="actions-bar">
    <a href="{{ url_for('export_csv') }}" class="btn btn-secondary">ðŸ“¥ Export CSV</a>
    
    <form method="post" action="{{ url_for('import_csv') }}" enctype="multipart/form-data" class="import-form">
        <label for="file" class="btn btn-secondary">ðŸ“¤ Import CSV</label>
        <input type="file" id="file" name="file" accept=".csv" style="display: none;" onchange="this.form.submit()">
    </form>
</div>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Symbol</th>
                <th>Category</th>
                <th>Quantity</th>
                <th>Buy Price</th>
                <th>Current Price</th>
                <th>Value</th>
                <th>P/L</th>
                <th>Return %</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for inv in investments %}
            <tr>
                <td>
                    <a href="{{ url_for('history', symbol=inv.symbol) }}" class="symbol-link">
                        {{ inv.symbol }}
                    </a>
                </td>
                <td>{{ inv.category }}</td>
                <td>{{ inv.quantity }}</td>
                <td>${{ inv.buy_price }}</td>
                <td>${{ inv.current_price }}</td>
                <td>${{ inv.value }}</td>
                <td class="{% if inv.profit_loss >= 0 %}positive{% else %}negative{% endif %}">
                    ${{ inv.profit_loss }}
                </td>
                <td class="{% if inv.pct_return >= 0 %}positive{% else %}negative{% endif %}">
                    {{ inv.pct_return }}%
                </td>
                <td class="actions-cell">
                    <a href="{{ url_for('edit_investment', id=inv.id) }}" class="action-link">Edit</a>
                    <form method="post" action="{{ url_for('delete_investment', id=inv.id) }}" style="display:inline;" onsubmit="return confirm('Delete {{ inv.symbol }}?');">
                        <button type="submit" class="action-btn delete-btn">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    const allocCtx = document.getElementById('allocationChart').getContext('2d');
    
    const allocationChart = new Chart(allocCtx, {
        type: 'pie',
        data: {
            labels: {{ category_labels|tojson }},
            datasets: [{
                data: {{ category_values|tojson }},
                backgroundColor: [
                    '#4285F4', '#EA4335', '#FBBC04', '#34A853', 
                    '#FF6D00', '#46BDC6', '#7B1FA2', '#F06292'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { 
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: { size: 12 }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: $${value.toFixed(2)} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
</script>

{% else %}
<div class="empty-state">
    <h3>ðŸ“Š No Investments Yet</h3>
    <p>Start building your portfolio by adding your first investment!</p>
    <a href="{{ url_for('add_investment') }}" class="btn btn-primary">Add Your First Investment</a>
</div>
{% endif %}

{% endblock %}
